---
title: "merge_runs.Rmd"
author: "Eily Allan"
date: "8/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
```

## Load datasets and metadata

We ran dada2 separately for each marker - and we have samples for each month split across multiple sequencing runs. So what we want to do is take the output from dada2 for each run and smash them together so we have one big ASV table for all the samples for a given marker. This means we are going to run this script each time we add another sequencing run. 

Check that here() starts at /Users/elizabethandruszkiewicz/GoogleDrive/UW/GitHub/NextGenNEPA

```{r just file paths so far}
# the asvs and hashes come from the output folder where each run has a subfolder for dada2 and then subfolders for each marker... 
# the metadata actually is stored somewhere else to keep all the columns that we want (not use dada2 generated metadata file) 

# now use the pattern to sort out the files - ^ means "starts with" 
all.asvs <- list.files(path = here("Output","dada2_output"), pattern = "^ASV_table.csv", recursive = T, full.names = T)
all.hashes <- list.files(path = here("Output","dada2_output"), pattern = "^Hash_key.csv", recursive = T, full.names = T,ignore.case = T)

all.metadata <- read.csv(here("Input", "sequencing_metadata_files", "master_sequencing_datasheet_20211026.csv"))

# now sort ASVs and hashes by marker
COI.asvs <- str_subset(all.asvs, "COI")
COI.hashes <- str_subset(all.hashes, "COI")

MiFish.asvs <- str_subset(all.asvs, "MiFish")
MiFish.hashes <- str_subset(all.hashes, "MiFish")

MiMammal.asvs <- str_subset(all.asvs, "MiMammal")
MiMammal.hashes <- str_subset(all.hashes, "MiMammal")

```

Now let's actually start pulling ASV and hash files together and merging them all - we will do the metadata after

```{r pull and merge ASV tables and hashes by markers}

# coi run 1 has sample as NGNX rather than sample name 
COI.ASV.table <- bind_rows(map(COI.asvs[2], read_csv))
COI1 <- read.csv(COI.asvs[1])
COI1$Sample_name <- as.character(COI1$Sample_name)
COI1 <- COI1 %>% select(-Locus) %>% left_join(all.metadata, by = "Sample_name") %>% select(Sample_ID,Locus,Hash,nReads) %>% rename("Sample_name" = "Sample_ID")
COI.ASV.table <- bind_rows(COI.ASV.table, COI1)

COI.hash.key <- bind_rows(map(COI.hashes, read_csv))
COI.hash.key <- COI.hash.key %>% 
  distinct(Hash, .keep_all = T) 

# mifish runs 1 and 4 have sample as NGNX rather than sample name so have to fix
MiFish.ASV.table <- bind_rows(map(MiFish.asvs[2:3], read_csv))
# we actually don't want to include run1 of mifish because we re-sequenced everything at 35 cycles instead of 40
MiFish4 <- read.csv(MiFish.asvs[4])
MiFish4$Sample_name <- as.character(MiFish4$Sample_name)
MiFish4 <- MiFish4 %>% select(-Locus) %>% left_join(all.metadata, by = "Sample_name") %>% select(Sample_ID,Locus,Hash,nReads) %>% rename("Sample_name" = "Sample_ID")
MiFish.ASV.table <- bind_rows(MiFish.ASV.table, MiFish4)

MiFish.hash.key <- bind_rows(map(MiFish.hashes, read_csv))
MiFish.hash.key <- MiFish.hash.key %>% 
  distinct(Hash, .keep_all = T) 

# mimammal runs 1 and 4 have sample as NGNX rather than sample name so have to fix
MiMammal.ASV.table <- bind_rows(map(MiMammal.asvs[2:3], read_csv))
MiMammal1 <- read.csv(MiMammal.asvs[1])
MiMammal1$Sample_name <- as.character(MiMammal1$Sample_name)
MiMammal1 <- MiMammal1 %>% select(-Locus) %>% left_join(all.metadata, by = "Sample_name") %>% select(Sample_ID,Locus,Hash,nReads) %>% rename("Sample_name" = "Sample_ID")
MiMammal4 <- read.csv(MiMammal.asvs[4])
MiMammal4$Sample_name <- as.character(MiMammal4$Sample_name)
MiMammal4 <- MiMammal4 %>% select(-Locus) %>% left_join(all.metadata, by = "Sample_name") %>% select(Sample_ID,Locus,Hash,nReads) %>% rename("Sample_name" = "Sample_ID")
MiMammal.ASV.table <- bind_rows(MiMammal.ASV.table, MiMammal1, MiMammal4)

MiMammal.hash.key <- bind_rows(map(MiMammal.hashes, read_csv))
MiMammal.hash.key <- MiMammal.hash.key %>% 
  distinct(Hash, .keep_all = T) 


# Write the Hash keys from start
COI.hash.key %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.COI.hash.key.csv"))
MiFish.hash.key %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.MiFish.hash.key.csv"))
MiMammal.hash.key %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.MiMammal.hash.key.csv"))

# Write the merged ASV tables
COI.ASV.table %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.COI.ASV.table.csv"))
MiFish.ASV.table %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.MiFish.ASV.table.csv"))
MiMammal.ASV.table %>% 
  write_csv(paste0(here("Output", "dada2_output"), "/", format(Sys.Date(), "%Y%m%d") , ".combined.MiMammal.ASV.table.csv"))

```
